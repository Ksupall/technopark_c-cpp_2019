addons:
apt:
update: true

stages:
  - build
  - memcheck
  - cppcheck
  - stylecheck
  - test

language: cpp

env:
    - CLANG_VERSION="6.0"

jobs:
  include:
    before_install:
    - sudo apt update
    - sudo apt install clang-format-${CLANG_VERSION} -version || true
    - vim --version
    - clang-format --version
    - unzip cppcheck-master.zip
    - cd cppcheck-master
    - make
    - sudo apt install valgrind
    - sudo apt install cmake
    - sudo apt install libgtest-dev
    - cd /usr/src/gtest
    - sudo cmake CMakeLists.txt
    - sudo make
    - sudo cp *.a /usr/lib
    - cd -
    
    stage: build
    before_script:
    - mkdir build
    - cd build
    - cmake .. -DCMAKE_BUILD_TYPE=$BUILD_CONFIGURATION -DTARGET_CPU=$TARGET_CPU
    - cmake --build .
    - make

    stage: memcheck
    script: valgrind --leak-check=full -q ./task_01/task_01

    stage: cppcheck
    script: ./cppcheck-master/cppcheck -q -j4 --enable=performance,portability,warning,style npp.6.5.3.src/ 2> npp.out
    
    stage: stylecheck
    script: clang-format -style=LLVM task_01/main.cpp -i
    
    stage: test
    script: ctest
            
    after_script: make clean